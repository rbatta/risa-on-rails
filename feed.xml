<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title></title>
    <description>Risa writes about Rails, Postgres, DevOps, and other things. She loves pairing, internet memes, cats, and all the cute things.
</description>
    <link>http://risaonrails.com/</link>
    <atom:link href="http://risaonrails.com/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Sun, 29 Mar 2015 10:59:17 -0700</pubDate>
    <lastBuildDate>Sun, 29 Mar 2015 10:59:17 -0700</lastBuildDate>
    <generator>Jekyll v2.5.3</generator>
    
      <item>
        <title>A Rails Double App Setup on Digital Ocean</title>
        <description>&lt;p&gt;I recently started using Digital Ocean because of work. Dat doing the devops bidness. Right. If you’re unfamiliar with Digital Ocean, they are a virtual server provider that uses SSD hard drives and a really cheap pricing plan.  Since it’s bare bones, you’re responsible for everything, from security, to installation of whatever. That being said, they DO (haha) provide some templates to make things easier. One of them is their Rails 1-click template, which has Nginx, Unicorn, and MySQL already installed. Right on!&lt;/p&gt;

&lt;p&gt;Hey, if LAMP stack is Linux Apache MySQL PHP and LEMP is the same but Nginx, then is this setup called LEMUR? Linux Nginx MySQL Unicorn Rails. And if it’s Postgres, then it’d be LEPUR? Well, I’m calling them this from here on out!&lt;/p&gt;

&lt;p&gt;That being said, what happens when you actually want to put TWO apps on a DO rails-template box?  There’s a lot of weird sometimes-reverse engineering going on with that, but overall, it’s totally possible to do. There isn’t any documentation on this, so if you run into this scenario, hopefully this helps you.&lt;/p&gt;

&lt;p&gt;The method I’m presenting here is the way I had set this up and got working.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;FULL DISCLAIMER&lt;/em&gt;&lt;/strong&gt; It’s a bit ugly, because I’m still new to this, and at the time no one else had done this before. Since I started writing this post, I realized that our setup was just not sustainable and have moved to using straight-up Ubuntu 14.10 boxes. Also, Ubuntu 14.04 does not support Postgres 9.4. Ew. But that’s a topic for another day.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt; I basically doubled all the unicorn conf files and doubled the server blocks in nginx.&lt;/p&gt;

&lt;h2 id=&quot;digital-ocean-1-click-rails-template&quot;&gt;Digital Ocean 1-Click Rails Template&lt;/h2&gt;

&lt;p&gt;Start with your standard Ubuntu setup and click the Rails template. Deploy. The DO template comes with a user already created called Rails. They have a great doc on &lt;a href=&quot;https://www.digitalocean.com/community/tutorials/how-to-use-the-1-click-ruby-on-rails-on-ubuntu-14-04-image&quot;&gt;how to set your own Rails app with their template&lt;/a&gt;, but here’s my modifications.  Since our apps are on the LEPUR stack, there’s a bit of extra work.&lt;/p&gt;

&lt;h3 id=&quot;bash-setup&quot;&gt;&amp;gt; Bash setup&lt;/h3&gt;
&lt;p&gt;First, start by installing git and Postgres. Skip the Postgres install if you’re sticking with LEMUR. I dropped the &lt;code&gt;sudo&lt;/code&gt; part since I’m logged in as &lt;code&gt;root&lt;/code&gt; user.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt-get update
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt-get install git
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt-get postgresql postgresql-contrib&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Set up git with your name and username. Switch to Postgres user account and create your psql user named &lt;code&gt;rails&lt;/code&gt; to keep it consistent with the already-created rails user. Gosh that’s confusing.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git config --global user.name &lt;span class=&quot;s2&quot;&gt;&amp;quot;YOURNAME&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git config --global user.email &lt;span class=&quot;s2&quot;&gt;&amp;quot;YOUREMAIL&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;su - postgres
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;createuser --interactive -P rails&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Follow the on screen commands for giving your rails postgres-user a password (keep it secret, keep it safe). Don’t give it superuser status. Safety first, after all. Exit out of the postgres user account. Set up the rails bash environment (autoload bash shell upon user switch) and create a directory for sockets in /var.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;chsh -s /bin/bash rails
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mkdir /var/sockets&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;two-rails-apps-setup&quot;&gt;&amp;gt; Two Rails apps setup&lt;/h3&gt;
&lt;p&gt;Now we add our 2 apps. For simplicity sake, I’m adding both of them into the /home/rails/ directory, once I empty it out. If you accidentally deleted the entire rails folder, just &lt;code&gt;mkdir rails&lt;/code&gt; in &lt;code&gt;/home&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rm -r /home/rails/*
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /home/rails
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git clone REPO1_ADDRESS
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /home/rails/REPO1
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rvm install RUBY1-VERSION-FOR-REPO1
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rvm use RUBY1
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gem install bundler
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;bundle install --without development &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Repeat this for the 2nd app (skipping the 1st &lt;code&gt;rm -r&lt;/code&gt; step, of course). I assume you have two completely different Ruby versions, as was the case with me: 2.0 and 2.2. H’okayso. You may have noticed me running bundle as &lt;code&gt;root&lt;/code&gt;. Digital Ocean is a bit weird. They want you to use &lt;code&gt;root&lt;/code&gt; to bundle install. I know, I know. Whatever. We work with what we’ve got. Hopefully don’t run into any hitches. Instead of using the &lt;code&gt;--deployment&lt;/code&gt; option, I’m using &lt;code&gt;--without development test&lt;/code&gt; because I could. (I’ve had issues with the deployment option.)&lt;/p&gt;

&lt;p&gt;Ok this part was the easy part. Like setting up 2 dev environments on your own local machine. :)  Once bundle has been run, chown it to the rails user. The command below should get both repos at once.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;chown rails:www-data -R /home/rails&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;unicorn&quot;&gt;&amp;gt; Unicorn&lt;/h3&gt;
&lt;p&gt;I struggled and searched the internet far and wide for someone who took the DO 1-click template to create 2 apps. Their template has a non-standard unicorn and nginx configuration (in terms of files and locations). Again, we work with what we got. The easiest way I found was to duplicate the unicorn files, which are located in two different places: &lt;code&gt;/etc/default/unicorn&lt;/code&gt; and &lt;code&gt;/home/unicorn/unicorn.conf&lt;/code&gt;. We’ll start with the latter. Out of sheer simplicity, the dupes had 2 appended to the end of it. I also use nano as my editor, so don’t judge. :)&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Optional step: If you’re paranoid like me, you can git init &lt;code&gt;/home/unicorn/&lt;/code&gt; directory so you can keep track of changes.&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;cp /home/unicorn/unicorn.conf /home/unicorn/unicorn2.conf

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nano /home/unicorn/unicorn.conf

&lt;span class=&quot;c&quot;&gt;# Edit repo 1&amp;#39;s unicorn.conf to look like this:&lt;/span&gt;
listen &lt;span class=&quot;s2&quot;&gt;&amp;quot;/var/sockets/unicorn.REPO1.sock&amp;quot;&lt;/span&gt;, :backlog &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 256
worker_processes 4
user &lt;span class=&quot;s2&quot;&gt;&amp;quot;rails&amp;quot;&lt;/span&gt;
working_directory &lt;span class=&quot;s2&quot;&gt;&amp;quot;/home/rails/REPO1&amp;quot;&lt;/span&gt;
pid &lt;span class=&quot;s2&quot;&gt;&amp;quot;/home/unicorn/pids/REPO1.pid&amp;quot;&lt;/span&gt;
stderr_path &lt;span class=&quot;s2&quot;&gt;&amp;quot;/home/unicorn/log/REPO1.log&amp;quot;&lt;/span&gt;
stdout_path &lt;span class=&quot;s2&quot;&gt;&amp;quot;/home/unicorn/log/REPO1.log&amp;quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Edit repo 2&amp;#39;s unicorn2.conf to look like this:&lt;/span&gt;
listen &lt;span class=&quot;s2&quot;&gt;&amp;quot;/var/sockets/unicorn.REPO2.sock&amp;quot;&lt;/span&gt;, :backlog &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 256
worker_processes 4
user &lt;span class=&quot;s2&quot;&gt;&amp;quot;rails&amp;quot;&lt;/span&gt;
working_directory &lt;span class=&quot;s2&quot;&gt;&amp;quot;/home/rails/REPO2&amp;quot;&lt;/span&gt;
pid &lt;span class=&quot;s2&quot;&gt;&amp;quot;/home/unicorn/pids/REPO2.pid&amp;quot;&lt;/span&gt;
stderr_path &lt;span class=&quot;s2&quot;&gt;&amp;quot;/home/unicorn/log/REPO2.log&amp;quot;&lt;/span&gt;
stdout_path &lt;span class=&quot;s2&quot;&gt;&amp;quot;/home/unicorn/log/REPO2.log&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I changed the listen statements to point to sockets as that is &lt;a href=&quot;http://www.gotealeaf.com/blog/setting-up-your-production-server-with-nginx-and-unicorn&quot;&gt;faster than going thru ports&lt;/a&gt; apparently. Default backlog is 1024, so you can leave or keep it.&lt;/p&gt;

&lt;p&gt;Onto the other unicorn config file. This file is the place that commands when the unicorn daemons start and such. Again, start with a copy/rename of the original for the 2nd repo. &lt;code&gt;Git init&lt;/code&gt; if you’re worried about messing things up royally. It really helps.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;cp /etc/default/unicorn /etc/default/unicorn2

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nano /etc/default/unicorn

&lt;span class=&quot;c&quot;&gt;# Edit these particular sections for Repo 1:&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Path to your web application, sh&amp;#39;ld be also set in server&amp;#39;s config.rb,&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# option &amp;quot;working_directory&amp;quot;. Rack&amp;#39;s config.ru is located here.&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;APP_ROOT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/rails/REPO1

&lt;span class=&quot;c&quot;&gt;# Server&amp;#39;s config.rb, it&amp;#39;s not a rack&amp;#39;s config.ru&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CONFIG_RB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/unicorn/REPO1.conf

&lt;span class=&quot;c&quot;&gt;# Where to store PID, sh&amp;#39;ld be also set in server&amp;#39;s config.rb, option &amp;quot;pid&amp;quot;.&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;PID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/unicorn/pids/REPO1.pid
&lt;span class=&quot;nv&quot;&gt;UNICORN_OPTS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;-D --config-file $CONFIG_RB -E production&amp;quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# change the RUBY_VERSION_REPO1 based on where&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# your rubies are located.&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/rvm/rubies/RUBY_VERSION_REPO1/bin/:/home/unicorn/.rvm/bin:/usr/local/sbin:/usr/bin:/bin:/sbin:&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;GEM_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/rvm/gems/RUBY_VERSION_REPO1
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;GEM_PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/rvm/gems/RUBY_VERSION_REPO1:/usr/local/rvm/gems/RUBY_VERSION_REPO1
&lt;span class=&quot;nv&quot;&gt;DAEMON&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/rvm/gems/RUBY_VERSION_REPO1/bin/unicorn

&lt;span class=&quot;c&quot;&gt;# Env vars needed for the system to run REPO1 because unicorn is silly&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# and doesn&amp;#39;t understand when Unix has your env vars.&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SECRET_TOKEN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;stick_your_secret_token_or_secret_key_base_token_hash
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;WHATEVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;env-vars-you-need&amp;#39;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If you’re not sure which ruby version you’re using, make sure you do &lt;code&gt;which ruby&lt;/code&gt; from &lt;em&gt;within&lt;/em&gt; the repo.&lt;/p&gt;

&lt;p&gt;Repeat these for the &lt;code&gt;unicorn2&lt;/code&gt; file, changing the values for the 2nd repo.&lt;/p&gt;

&lt;p&gt;One very. important. step. left with your unicorn setup. You’ve got to make a double of your unicorn initializer. That’s located in &lt;code&gt;/etc/init.d/&lt;/code&gt; as &lt;code&gt;unicorn&lt;/code&gt;.  Copy it and then edit the parts that references Unicorn.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;cp /etc/init.d/unicorn /etc/init.d/unicorn2

&lt;span class=&quot;c&quot;&gt;# here are the parts I changed in unicorn2&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;unicorn2
&lt;span class=&quot;nv&quot;&gt;DESC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;Unicorn2 web server&amp;quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; -f /etc/default/unicorn2 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
  . /etc/default/unicorn2
&lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;PID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-/run/unicorn2.pid&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;

check_config&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$CONFIGURED&lt;/span&gt; !&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;yes&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
    exit_with_message &lt;span class=&quot;s2&quot;&gt;&amp;quot;Unicorn2 is not configured (see /etc/default/unicorn2).&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This allows us to run commands like &lt;code&gt;service unicorn2 start|stop|restart&lt;/code&gt; much like how the regular unicorn is done.&lt;/p&gt;

&lt;p&gt;Time to restart all the unicorn services.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service unicorn restart
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service unicorn2 restart&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;You can confirm that both are running by checking &lt;code&gt;top -c&lt;/code&gt; then press &lt;code&gt;shift-M&lt;/code&gt;. Since we named the 2nd unicorn2, your top should have unicorn and unicorn2 running. Score!&lt;/p&gt;

&lt;h3 id=&quot;nginx&quot;&gt;&amp;gt; Nginx&lt;/h3&gt;
&lt;p&gt;Now for the final bit. Nginx’s configuration.&lt;/p&gt;

&lt;p&gt;If you opt to &lt;code&gt;git init&lt;/code&gt; your nginx configuration, do it in &lt;code&gt;/etc/nginx/&lt;/code&gt; directory rather than &lt;code&gt;/etc/nginx/sites_enabled/&lt;/code&gt; because any extra files in this directory will be read in by nginx.&lt;/p&gt;

&lt;p&gt;I kept both apps’ information in the default file as different server blocks, but you can keep them in separate files if you’d like. Whatever floats your boat.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# anything that isn&amp;#39;t https&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# becomes https, permanently&lt;/span&gt;
server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  listen 80&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    server_name DOMAIN1.com&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  rewrite ^ https://&lt;span class=&quot;nv&quot;&gt;$server_name$request_uri&lt;/span&gt;? permanent&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# anything that&amp;#39;s not https gets redirected to&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# domain2.com&lt;/span&gt;
server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  listen 80&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  server_name DOMAIN2.com&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;301&lt;/span&gt; https://DOMAIN2.com&lt;span class=&quot;nv&quot;&gt;$request_uri&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# upstream for unicorn on repo 1. make sure&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# sockets location is same as in /home/unicorn/unicorn.conf&lt;/span&gt;
upstream unicorn-REPO1 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  server unix:/var/sockets/unicorn.REPO1.sock&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# SSL info for repo 1.&lt;/span&gt;
server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  listen 443&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  server_name REPO1.com&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  ssl on&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  ssl_certificate /etc/ssl/REPO1.com.crt&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  ssl_certificate_key /etc/ssl/REPO1.com.key&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# location of repo 1&amp;#39;s public dir&lt;/span&gt;
  root /home/rails/REPO1/public&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  client_max_body_size 1024M&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  location / &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    try_files &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;/index.html &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;.html &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt; @app&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  location ~* ^.+&lt;span class=&quot;se&quot;&gt;\.&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;jpg&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;jpeg&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;gif&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;png&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;ico&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;zip&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;tgz&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;gz&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;rar&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;bz2&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;doc&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;xls&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;exe&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;pdf&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;ppt&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;txt&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;tar&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;mid&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;midi&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;wav&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;bmp&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;rtf&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;mp3&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;flv&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;mpeg&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;avi&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    try_files &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt; @app&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# change proxy_pass to the upstream name from above&lt;/span&gt;
  location @app &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    proxy_set_header X-Forwarded-For &lt;span class=&quot;nv&quot;&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    proxy_set_header Host &lt;span class=&quot;nv&quot;&gt;$http_host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    proxy_redirect off&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    proxy_read_timeout 600&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    proxy_pass http://unicorn-REPO1&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# for things to be downloaded properly&lt;/span&gt;
  location /files/ &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;alias&lt;/span&gt; /home/rails/REPO1/some-directory/&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    internal&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# upstream for unicorn on repo 2. make sure&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# sockets location is same as in /home/unicorn/unicorn2.conf&lt;/span&gt;
upstream unicorn-REPO2 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  server unix:/var/sockets/unicorn.REPO2.sock&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# SSL config for server 2&lt;/span&gt;
server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  listen &lt;span class=&quot;m&quot;&gt;443&lt;/span&gt; ssl&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  server_name DOMAIN2.com&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  ssl on&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  ssl_certificate /etc/ssl/REPO2.com.crt&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  ssl_certificate_key /etc/ssl/REPO2.com.key&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# location of repo 1&amp;#39;s public dir&lt;/span&gt;
  root /home/rails/REPO2/public&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  index index.html index.htm&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  location / &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    try_files &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;/index.html &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;.html &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt; @app&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  location ~* ^.+&lt;span class=&quot;se&quot;&gt;\.&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;jpg&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;jpeg&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;gif&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;png&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;ico&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;zip&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;tgz&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;gz&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;rar&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;bz2&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;doc&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;xls&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;exe&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;pdf&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;ppt&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;txt&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;tar&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;mid&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;midi&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;wav&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;bmp&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;rtf&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;mp3&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;flv&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;mpeg&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;avi&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    try_files &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt; @app&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# change the proxy_pass to point to upstream&amp;#39;s name&lt;/span&gt;
  location @app &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    proxy_set_header X-Forwarded-For &lt;span class=&quot;nv&quot;&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    proxy_set_header Host &lt;span class=&quot;nv&quot;&gt;$http_host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    proxy_redirect off&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    proxy_pass http://unicorn-REPO2&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Server blocks are where you put all the good stuff that nginx needs to know with what to do. Since the app we had needed to be automatically changed to https, the listen 80 directive wasn’t that important - just needed to redirect to things properly.&lt;/p&gt;

&lt;p&gt;SSL certs and keys were placed in &lt;code&gt;/etc/ssl/&lt;/code&gt;. If you’ve got intermediate keys, you will want to have them combined into one giant .crt file.&lt;/p&gt;

&lt;p&gt;Check to ensure that your nginx config is syntactically correct. If all good, restart nginx!&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nginx -t
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service nginx restart&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Correct any mistakes. Make sure each directive ends with a &lt;code&gt;;&lt;/code&gt; !!!&lt;/p&gt;

&lt;p&gt;And voila! You’re good to go. Switch to the rails user to run your standard rake commands like &lt;code&gt;rake db:setup&lt;/code&gt; and &lt;code&gt;assets:precompile&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&quot;final-thoughts&quot;&gt;Final thoughts&lt;/h3&gt;
&lt;p&gt;I am sure you may have some errors for each ruby. Definitely check your logs for nginx and unicorn. When we did this, we had to re-connect the executable-hook for each of the apps since we used different ruby versions for the apps. Stack Overflow had some brilliant articles that helped us troubleshoot. I can’t recall which ones they were but if I encounter them again, I’ll post it here.&lt;/p&gt;

&lt;p&gt;Also, I’m a huge fan of making my life easier, so I created aliases for root to restart services.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;touch .bash_aliases
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nano .bash_aliases

&lt;span class=&quot;c&quot;&gt;# copy paste this into the file&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;restart-all&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;service nginx restart; service unicorn restart; service unicorn2 restart&amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;restart-unicorns&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;service unicorn restart; service unicorn2 restart&amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;restart-nginx&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;service nginx restart&amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;====================================&amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;       Restart shortcuts            &amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;====================================&amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;restart-all      = restart nginx and both unicorn &amp;amp; unicorn2&amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;restart-unicorns = restart both unicorns&amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;restart-nginx    = restart nginx&amp;#39;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# source your bashrc file to reload shell&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# the echo output should be displayed at the top&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; ~/.bashrc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now you’ll be able to run &lt;code&gt;restart-all&lt;/code&gt; to restart all your services. Woohoo! This is super handy when troubleshooting. And remember, when in doubt, &lt;code&gt;restart-all&lt;/code&gt; sometimes does the trick. :)&lt;/p&gt;

&lt;p&gt;A final word. If you find that your app needs to use Sidekiq or Resque, and you want to use Foreman + Upstart to drive your background workers from your Procfile, I suggest that you do &lt;em&gt;NOT&lt;/em&gt; want to use this 1-click template.&lt;/p&gt;

&lt;p&gt;&lt;i class=&quot;fa fa-angle-double-up&quot;&gt;&lt;/i&gt; Level up +50&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Questions? Comments? I know I can make this cleaner, but there was NO article out there that talked about setting up 2 rails apps using the 1-click Digital Ocean rails template. Seriously. But if you’re stuck and are following these directions, shoot me an email and let me know! I’ll do my best to help if I can.  Hit me up at &lt;a href=&quot;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#116;&amp;#111;:&amp;#114;&amp;#105;&amp;#115;&amp;#097;&amp;#111;&amp;#110;&amp;#114;&amp;#097;&amp;#105;&amp;#108;&amp;#115;&amp;#064;&amp;#103;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#046;&amp;#099;&amp;#111;&amp;#109;&quot;&gt;risaonrails &lt;i class=&quot;fa fa-paper-plane-o&quot;&gt;&lt;/i&gt;&lt;/a&gt;!&lt;/p&gt;

</description>
        <pubDate>Sun, 29 Mar 2015 00:00:00 -0700</pubDate>
        <link>http://risaonrails.com/a-rails-double-app-setup/</link>
        <guid isPermaLink="true">http://risaonrails.com/a-rails-double-app-setup/</guid>
        
        <category>rails</category>
        
        <category>nginx</category>
        
        <category>digital ocean</category>
        
        <category>setup</category>
        
        <category>unicorn</category>
        
        <category>double</category>
        
        
        <category>rails</category>
        
        <category>digital</category>
        
        <category>ocean</category>
        
        <category>nginx</category>
        
      </item>
    
      <item>
        <title>Integrating Monit to Slack</title>
        <description>&lt;p&gt;The conversation of what software are we going to choose for monitoring our apps and servers came up at work. We’ve all used New Relic and Nagios before, but not really Monit. New Relic is free to a certain point, but can get hella expensive if you’ve got multiple apps and want to check many different things. Both Nagios and Monit are open-source, which equates to &lt;em&gt;FREE&lt;/em&gt;. Perfect for dev shops and small businesses.&lt;/p&gt;

&lt;p&gt;Since I like to read a lot of different articles while researching things, I kept coming across Monit as the go-to tool for monitoring instead of Nagios. Plus my boss had some bad experiences with setting it up before. Well, my Google-fu is fairly strong, so I decided to give Monit a try.&lt;/p&gt;

&lt;p&gt;I admit, setup was fairly simple.  Currently our stack is LEPPR (Linux Nginx Passenger Postgres Rails), not that it matters though. So real quick, here were the steps I used to set it up, before going to the meat of the article: integrating with Slack.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;sudo apt-get install monit&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The file you want to edit will be &lt;code&gt;/etc/monit/monitrc&lt;/code&gt; which is the main config file. Comment out the bits about the httpd section, about mid-way thru, and add in your info as needed. As always, geared for Digital Ocean:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;set httpd port 2812 and
  use address IP_ADDRESS       # Put your droplet IP here
  allow 0.0.0.0/0.0.0.0        # allow anyone to connect to the server and
  allow admin:&#39;P@ssw0rd&#39;       # require user and password for login
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What this does is allow you to hit up your IP address in the browser and see how things are looking: http://IP_ADDRESS:2812.&lt;/p&gt;

&lt;p&gt;Right on.&lt;/p&gt;

&lt;p&gt;Now, let’s integrate!&lt;/p&gt;

&lt;h3 id=&quot;on-slack&quot;&gt;On Slack&lt;/h3&gt;
&lt;p&gt;If you’re running the desktop app, click on the channel name’s &lt;code&gt;v&lt;/code&gt; down-button and choose Configure Integrations.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;On the web page, choose “&lt;em&gt;Or, make your own!&lt;/em&gt;” which should take you to /services/new#diy.&lt;/li&gt;
  &lt;li&gt;Click Add for &lt;strong&gt;Incoming Webhooks&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;You can choose a channel or make a new one. I created one called &lt;code&gt;#monitoring&lt;/code&gt; because I’m not original.&lt;/li&gt;
  &lt;li&gt;Click Add Integration.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So now you’ve got a webhook URL that looks something like this: https://hooks.slack.com/services/HASH/Hash/LongHash.  You can test out if it works by scrolling to the bottom and picking the integration settings, choosing what you want for description, custom name, etc. Test it out with the &lt;code&gt;curl&lt;/code&gt; command that they give you.  It’s JSON that drives the entire thing.&lt;/p&gt;

&lt;h3 id=&quot;on-monit&quot;&gt;On Monit&lt;/h3&gt;
&lt;p&gt;Now, back to the box. We’re rubyists here so this is how we roll. We’re going to create a file called &lt;code&gt;slack.rb&lt;/code&gt; in your &lt;code&gt;/etc/monit/&lt;/code&gt; directory.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;sudo touch /etc/monit/slack.rb
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;sudo nano /etc/monit/slack.rb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now in this file, insert this:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;span class=&quot;c1&quot;&gt;#!/usr/bin/ruby&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;net/https&amp;#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;json&amp;#39;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;URI&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;https://hooks.slack.com/services/HASH/Hash/LongHash&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Net&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;use_ssl&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Net&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Post&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request_uri&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-Type&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;application/json&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&amp;quot;channel&amp;quot;&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;#monitoring&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# channel name&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&amp;quot;username&amp;quot;&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;Monit Bot&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;# you can name the bot whatever&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&amp;quot;icon_emoji&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;:trollface:&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;      &lt;span class=&quot;c1&quot;&gt;# because why the hell not!&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;       &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;[&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;MONIT_HOST&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;] &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;MONIT_SERVICE&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; - &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;MONIT_DESCRIPTION&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;to_json&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;puts&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The cool thing about this is that you can pick whatever slack icon you want to use OR you can even upload your own for an emoji and use that. Obviously you’ll have to change the &lt;code&gt;uri&lt;/code&gt;, &lt;code&gt;channel&lt;/code&gt;, &lt;code&gt;username&lt;/code&gt; and the like to what applies to you.&lt;/p&gt;

&lt;p&gt;Do a sanity check at this point to make sure everything’s correct. Run the ruby script real quick-like.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ruby /etc/monit/slack.rb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Did you get a notification in Slack?  Great, now make that into an executable file!&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;sudo chmod +x /etc/monit/slack.rb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;You will need to invoke this file whenever something happens, so to test it out, we’re going to create an nginx file to monitor nginx. This will be kept in &lt;code&gt;/etc/monit/conf.d/&lt;/code&gt; directory as a file called &lt;code&gt;nginx&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;check process nginx with pidfile /var/run/nginx.pid
  start &lt;span class=&quot;nv&quot;&gt;program&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;/usr/sbin/service nginx start&amp;quot;&lt;/span&gt;
  stop  &lt;span class=&quot;nv&quot;&gt;program&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;/usr/sbin/service nginx stop&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; failed host 127.0.0.1 port &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; restart
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; changed pid &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; /etc/monit/slack.rb    &lt;span class=&quot;c&quot;&gt;# this is our sanity check&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; failed host 127.0.0.1 port &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; /etc/monit/slack.rb &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; succeeded &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; /etc/monit/slack.rb
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; cpu is greater than 40% &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt; cycles &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; /etc/monit/slack.rb &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; succeeded &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; /etc/monit/slack.rb
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; cpu &amp;gt; 60% &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; cycles &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; restart&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The basic format is that whenever you need to invoke an alert, instead of a &lt;code&gt;then alert&lt;/code&gt;, you are changing it to execute the slack.rb file. You &lt;strong&gt;must&lt;/strong&gt; specify the full path to slack.rb. Pretty much any time you see a &lt;code&gt;then alert&lt;/code&gt;, change it to &lt;code&gt;then exec /etc/monit/slack.rb&lt;/code&gt;. :)&lt;/p&gt;

&lt;p&gt;Check to ensure file is correct, reload monit to accept the changes, and then stop/start nginx.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;sudo monit -t       &lt;span class=&quot;c&quot;&gt;# if errors, fix!&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;sudo monit reload
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;sudo service nginx stop
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;sudo service nginx start&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;There’s a few second delay but check out slack! You should see the message with your info all in there. HURRAY!&lt;/p&gt;

&lt;p&gt;This article used an Ubuntu 14.10 droplet.&lt;/p&gt;

&lt;p&gt;&lt;i class=&quot;fa fa-angle-double-up&quot;&gt;&lt;/i&gt; Level up +3&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Questions? Comments? Hit me up at &lt;a href=&quot;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#116;&amp;#111;:&amp;#114;&amp;#105;&amp;#115;&amp;#097;&amp;#111;&amp;#110;&amp;#114;&amp;#097;&amp;#105;&amp;#108;&amp;#115;&amp;#064;&amp;#103;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#046;&amp;#099;&amp;#111;&amp;#109;&quot;&gt;risaonrails &lt;i class=&quot;fa fa-paper-plane-o&quot;&gt;&lt;/i&gt;&lt;/a&gt;!&lt;/p&gt;

</description>
        <pubDate>Fri, 27 Mar 2015 00:00:00 -0700</pubDate>
        <link>http://risaonrails.com/integrate-monit-with-slack/</link>
        <guid isPermaLink="true">http://risaonrails.com/integrate-monit-with-slack/</guid>
        
        <category>slack</category>
        
        <category>monit</category>
        
        <category>devops</category>
        
        
        <category>devops</category>
        
        <category>monit</category>
        
        <category>slack</category>
        
      </item>
    
      <item>
        <title>A Quick Tip with Database Formatting</title>
        <description>&lt;p&gt;I’m constantly learning, mostly at this new job. It’s gotten to the point where I end up diving down the rabbit hole many many times. Don’t get me wrong, I love every bit of it. Might even say I’m addicted to it. Today’s tip is brought to you by both MySQL &amp;amp;&amp;amp; Postgres! Whoa, a double feature.&lt;/p&gt;

&lt;h3 id=&quot;the-problem&quot;&gt;The problem&lt;/h3&gt;
&lt;p&gt;Know what I really don’t like? Having to check the database and getting results that are displayed all sorts of wonky because your terminal window wraps things when you run &lt;code&gt;select * from that_table where id=&#39;1&#39;;&lt;/code&gt;. It looks something like this in MySQL:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/quick-tip-mysql.png&quot; alt=&quot;MySQL&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Oh man. Postgres isn’t that much better, y’know.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/quick-tip-postgres.png&quot; alt=&quot;Postgres&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;the-solution&quot;&gt;The Solution&lt;/h3&gt;
&lt;p&gt;So what do? In MySQL, every SQL command that needs to be formatted pretty needs to have \G appended at the end. &lt;code&gt;select * from that_table where id=&#39;1&#39; \G;&lt;/code&gt; Annoying to have to append &lt;code&gt;\G&lt;/code&gt; to the end, but it’s worth it. Here’s the result:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/quick-tip-mysql1.png&quot; alt=&quot;MySQL&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Postgres is a bit better in this regard. There’s a global setting called &lt;code&gt;\x auto&lt;/code&gt; which automatically prettifies the information based on terminal width. The only downside is if you’ve got a text column that’s so long it makes the actual header wrap. I’ll take it anyway, because once it’s set, it’s set until you change it.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/quick-tip-postgres1.png&quot; alt=&quot;Postgres&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Right on! This makes viewing records directly in the database so much easier.&lt;/p&gt;

&lt;p&gt;&lt;i class=&quot;fa fa-angle-double-up&quot;&gt;&lt;/i&gt; Level up +1&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Questions? Comments? Hit me up at &lt;a href=&quot;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#116;&amp;#111;:&amp;#114;&amp;#105;&amp;#115;&amp;#097;&amp;#111;&amp;#110;&amp;#114;&amp;#097;&amp;#105;&amp;#108;&amp;#115;&amp;#064;&amp;#103;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#046;&amp;#099;&amp;#111;&amp;#109;&quot;&gt;risaonrails &lt;i class=&quot;fa fa-paper-plane-o&quot;&gt;&lt;/i&gt;&lt;/a&gt;!&lt;/p&gt;

</description>
        <pubDate>Fri, 20 Mar 2015 00:00:00 -0700</pubDate>
        <link>http://risaonrails.com/a-quick-tip-with-database-formatting/</link>
        <guid isPermaLink="true">http://risaonrails.com/a-quick-tip-with-database-formatting/</guid>
        
        <category>postgres</category>
        
        <category>mysql</category>
        
        <category>tips</category>
        
        
        <category>postgres</category>
        
        <category>mysql</category>
        
      </item>
    
      <item>
        <title>Postgres Workshop Notes</title>
        <description>&lt;p&gt;Hi there!&lt;/p&gt;

&lt;p&gt;Missed the Postgres workshop? Forgot what I covered? This post was made just for you then! :)&lt;/p&gt;

&lt;p&gt;Quick background on Postgres. It’s a relational database that is awesome because it’s highly extensible. For instance there is geospacial support (postGIS), key/value store (hstore), and with postgres 9.4, there’s JSON support (more so than what they had previously). You could say it’s the end-all-be-all for databases. At least that’s what I’d like to see it as! Obviously postgres may not suit your needs but this knowledge is valuable and transferable. And if you were afraid of reading the docs before, hopefully after this you won’t be.&lt;/p&gt;

&lt;h3 id=&quot;what-to-expect&quot;&gt;What to expect&lt;/h3&gt;
&lt;p&gt;I’ll walk thru entering/exiting Postgres. Then a bit of navigation so you feel more comfortable with it. And then we’re going to go straight into dealing with import/export (restore/backup). For the import/export section, I’ve a chump vanilla Rails app that will be used because there’s a rake task in there that creates fake data. Hurray for the Faker gem!&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;first-things-first&quot;&gt;First thing’s first&lt;/h3&gt;
&lt;p&gt;Let’s make sure you can run Postgres.&lt;/p&gt;

&lt;p&gt;On a Mac, you have a couple of options:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Download the &lt;a href=&quot;http://postgresapp.com/&quot;&gt;postgresapp&lt;/a&gt;. Double-click to open and run it. Boom, postgres is running. You’ll see it as the cute lil elephant icon in your menu bar up top. If you quit the app, you quit the postgres server.&lt;/li&gt;
  &lt;li&gt;Follow this &lt;a href=&quot;http://www.mikeball.us/blog/setting-up-postgres-with-homebrew/&quot;&gt;super awesome guide&lt;/a&gt;. This is what I used to set my machine up. I prefer this to Postgresapp, truthfully.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;On *nix machines, use &lt;a href=&quot;http://www.postgresql.org/download/linux/&quot;&gt;the official documentation&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;On Windows, you can use &lt;a href=&quot;http://www.postgresql.org/download/windows/&quot;&gt;this guide&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Sorry *nix and Windows users. I’m a Mac user so the entire thing is geared for this. Don’t hate!&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;go-in-go-out&quot;&gt;Go in, go out&lt;/h3&gt;
&lt;p&gt;Once you’ve followed the instructions for installation and have postgres running, we can confirm this by running &lt;code&gt;psql&lt;/code&gt; in Terminal.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ psql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Did you get an error saying &lt;code&gt;FATAL role &quot;YOURNAME&quot; does not exist&lt;/code&gt; ? It’s saying that the user account you’re logged in as isn’t a postgres user. We’ve got to create it. Use the command below and make sure to use the name that the role says doesn’t exist. Say yes when they ask if the user (you) should be superuser.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ createuser --interactive YOURNAME
# Shall the new role be a superuser? (y/n) Y
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Did you get an error saying &lt;code&gt;FATAL database &quot;YOURNAME&quot; does not exist&lt;/code&gt;? Simple enough, we’ll just create it. Use the following command to create that particular database. Make sure you use the name that it references.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ createdb YOURNAME
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, in we go. The postgres prompt you see should have your account name if you followed the above steps. Since my account name is risa, my postgres username and database are risa. The prompt for me looks like &lt;code&gt;risa=#&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ psql
risa=#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Great. Let’s quit out of postgres. The command is &lt;code&gt;\q&lt;/code&gt; (not the usual / one. It’s the \ above the return button)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;risa=# \q
$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It’s always important to know how to exit any program. Otherwise you might be stuck in &lt;a href=&quot;https://twitter.com/iamdevloper/status/435555976687923200&quot;&gt;vim foreverrrrr&lt;/a&gt;.&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;navigation&quot;&gt;Navigation&lt;/h3&gt;
&lt;p&gt;To find out where we’re at currently, type &lt;code&gt;\conninfo&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ psql
risa=# \conninfo
# You are connected to database &quot;risa&quot; as user &quot;risa&quot; via socket in &quot;/tmp&quot; at port &quot;5432&quot;.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To list the databases you’ve got in postgres, type &lt;code&gt;\l&lt;/code&gt; (l for list)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;risa=# \l
# you&#39;ll get an output that lists a bunch of databases, including template0 and template1.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;Note: template1 is what all new databases use when they get created. If you add an extension like &lt;code&gt;pg_stat_statement&lt;/code&gt; into template1, all your subsequent databases will have that extension turned on automatically. AWESOME.&lt;br /&gt;
Template0 is the ultimate empty database. If you accidentally mess up template1, then you can use template0 to fix it. 
I’ll include directions on this maybe at the end or in another blog, but this wasn’t part of the workshop.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;To change databases, you will have to do &lt;code&gt;\c DATABASE_NAME&lt;/code&gt;. Since I don’t know what databases you’ve already got in your system, I’ll use template1 as an example.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;risa=# \c template1
template1=#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice that the prompt changed. The prompt always points to the current database you’re in. Sweet.&lt;/p&gt;

&lt;p&gt;Let’s hop out and do some Rails things so we can look a bit deeper into postgres.&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;rails-setup&quot;&gt;Rails setup&lt;/h3&gt;
&lt;p&gt;Please clone this repo: &lt;a href=&quot;https://github.com/rbatta/img_blog&quot;&gt;image blog&lt;/a&gt;. It’s my vanilla rails app based on the &lt;a href=&quot;https://www.railstutorial.org/book&quot;&gt;Michael Hartl tutorial&lt;/a&gt;&lt;br /&gt;
It uses ruby 2.0.0, so you may have to use rvm or rbenv to change ruby versions for this app.&lt;/p&gt;

&lt;p&gt;Once cloned and ruby version is changed to 2.0.0, run the usual suspects:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;bundle install
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rake db:setup&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;With Rails 4.0 and below, &lt;code&gt;rake db:setup&lt;/code&gt; created a dev database with migrations run &lt;strong&gt;as well as an empty test database&lt;/strong&gt;.  In Rails 4.1+, &lt;code&gt;db:setup&lt;/code&gt; no longer creates an empty test database. You have to manually run &lt;code&gt;RAILS_ENV=test rake db:setup&lt;/code&gt;. Silly, I know.&lt;/p&gt;

&lt;p&gt;So, what did that rake db:setup do? Let’s find out.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ psql
risa=# \l
# you should see these 2 added into your database list
# imgblog_dev       | risa  | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
# imgblog_test      | risa  | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Boom. Now, let’s hop into the imgblog_dev database and check out the tables and stuff. BTW, you can press tab to autocomplete database names (and sometimes table names too). The command for displaying tables is &lt;code&gt;\dt&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;risa=# \c imgblog_dev
imgblog_dev=# \dt
# you should see 3 tables. images and users are the tables
# schema_migrations has the indexes
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you’re curious as to how big your tables might be, you can also do &lt;code&gt;\dt+&lt;/code&gt; which gives you sizes as well.&lt;/p&gt;

&lt;p&gt;To see what’s in the tables, you can then do your standard SQL query:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;imgblog_dev=# select * from users;
# this will display any/all your users and their columns. 
# right now it&#39;s empty so you just see column names.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you just want to see the column names of the users table, you can do &lt;code&gt;\d users&lt;/code&gt; instead.&lt;/p&gt;

&lt;p&gt;Great. Let’s hop back out and put some real data in to do some backups and restores. Assuming you’re still in the root directory of the img_blog, run the rake command to create a bunch of fake data.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;imgblog_dev=# \q
$ rake db:populate
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Hop in and confirm that data was created. I’m going to append the database name to the &lt;code&gt;psql&lt;/code&gt; statement to automatically go to that database.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ psql imgblog_dev
imgblog_dev=# SELECT * FROM users;
# you should see a bunch of output that might be cut off
# scroll with the arrow keys
# get the prompt back by pressing Q.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let’s count how many users and images were created. (Answer: 33 users, 66 images)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;imgblog_dev=# select count(*) from users;
# you get back 33
imgblog_dev=# select count(*) from images;
# you get back 66
imgblog_dev=# \q
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Awesome. Great job so far!! Time to start the backup / restore process. I’ll go through the commands and append more flags as I go along, explaining each one. By the end, you should have about 4 backup files created.&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;backup-and-restore-export-and-import&quot;&gt;Backup and Restore (Export and Import)&lt;/h3&gt;

&lt;h4 id=&quot;backup-first&quot;&gt;Backup first&lt;/h4&gt;
&lt;p&gt;Backups are created with the &lt;code&gt;pg_dump&lt;/code&gt; command, but in order for it to know what to do, you have to append flags (options) to the command and send the output to a file.  We’re going to be taking backups of &lt;code&gt;imgblog_dev&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ pg_dump -d imgblog_dev &amp;gt; ~/Desktop/dump1.sql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If I had to read it out loud, it is saying “Take a dump (haha) of database imgblog_dev and send it to the Desktop and call it dump1.sql.” The &lt;code&gt;-d&lt;/code&gt; flag stands for database. The &lt;code&gt;&amp;gt;&lt;/code&gt; is to output the contents to a file in some location. In this case it’s to the Desktop, as dump1.sql. Why &lt;code&gt;.sql&lt;/code&gt; ? Truthfully, the extension doesn’t matter. It can be &lt;code&gt;.txt&lt;/code&gt;, &lt;code&gt;.asdf&lt;/code&gt;, or whatever. But for sanity sake, &lt;code&gt;.sql&lt;/code&gt;. You’ll see why when you open up the file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ subl ~/Desktop/dump1.sql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Assuming you’ve got sublime as your text editor with that shortcut, that’ll work. Otherwise do what you normally do when opening up files. :) When you do, you’ll see that it’s got a bunch of SQL commands. If you look more closely, you’ll see that they have some &lt;code&gt;CREATE TABLE&lt;/code&gt; commands and then &lt;code&gt;COPY&lt;/code&gt; commands for the actual data. You’ve taken a human-readable backup of the database.&lt;/p&gt;

&lt;p&gt;What if all we want is the data? Imagine we’re transfering the information to another database and it’s already got tables set up because we’ve run migrations. What then? Let’s set some more flags.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ pg_dump -d imgblog_dev -a -O &amp;gt; ~/Desktop/dump2.sql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, so we’ve set 2 more flags: &lt;code&gt;-a&lt;/code&gt; and &lt;code&gt;-O&lt;/code&gt; (capital o, not zero). The &lt;code&gt;-a&lt;/code&gt; flag stands for &lt;code&gt;--data-only&lt;/code&gt;, so telling it to take only the data. The &lt;code&gt;-O&lt;/code&gt; command is &lt;code&gt;--no-owner&lt;/code&gt; which means remove all traces of ownership when getting this backup.  If you open up this file and compare it to dump1, here’s the kind of thing you’ll see.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# On ~ line 34 of dump1.sql, you&#39;ll see the owner as yourself
-- Name: images; Type: TABLE; Schema: public; Owner: risa; Tablespace: 

# On ~ line 15 of dump2.sql, you don&#39;t see an owner listed
-- Data for Name: images; Type: TABLE DATA; Schema: public; Owner: -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Quick visual check also comfirms that dump2 only has data listed. No reference to tables.&lt;/p&gt;

&lt;p&gt;Imagine you’re working on a production database, hosted on Digital Ocean at IP address 127.0.0.1 and port 5432. (Reality: 127.0.0.1 == localhost == your computer’s own IP address) This theoretical database is like 2GB large (whoa), and you need to transfer it to your dev env. It’s gonna be a pain to download all 2GB. Let’s compress it down, like an archive file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ pg_dump -h 127.0.0.1 -p 5432 -d imgblog_dev -a -O -Fc &amp;gt; ~/Desktop/dump3.dump
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The flags to connect: &lt;code&gt;-h&lt;/code&gt; is for host, usually an IP or a .com kind of address; &lt;code&gt;-p&lt;/code&gt; is for port, default postgres port is 5432 but it can be set to anything.  The next new flag is the &lt;code&gt;-Fc&lt;/code&gt; flag. I like to think of it as “format compressed” but in reality it is “format custom.” There are other &lt;code&gt;-F&lt;/code&gt; options, like &lt;code&gt;-Ft&lt;/code&gt; and &lt;code&gt;-Fd&lt;/code&gt; which will also archive your file, but &lt;code&gt;-Fc&lt;/code&gt; is the one you want. Finally, notice that I changed the extension to &lt;code&gt;.dump&lt;/code&gt;. Again, it’s a sanity thing. Appending that lets me know that it’s actually a compressed file that I’m dealing with.&lt;/p&gt;

&lt;p&gt;If you open this file, you’ll immediately notice how it is completely human-readable gibberish and gobbledigook. :) It’s compressed after all. Postgres can understand it; we just know that the file is a lot smaller in size.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ pg_dump -h 127.0.0.1 -p 5432 -U risa -d imgblog_dev -Fc -a -O &amp;gt; ~/Desktop/dump4.dump
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This combines pretty much all the flags I’ve covered thus far with the addition of &lt;code&gt;-U&lt;/code&gt; which is user. In your case, make sure you put your postgres username in, since you won’t have a risa user (unless your name is Risa as well. Hi!)&lt;/p&gt;

&lt;p&gt;Congrats! You’ve gotten this far. One last stretch. Importing/restoring things back in!&lt;/p&gt;

&lt;h4 id=&quot;then-restore&quot;&gt;Then Restore&lt;/h4&gt;
&lt;p&gt;In the real world, you may have times when databases get completely effed up. Hopefully you’ve got redundant databases or at least a scheduled backup system set up. When this happens, we need to sometimes restore the database to a previously known state. It also means there’s a chance of some loss of data. (Having a failover plan is essential, btw.) Othertimes, maybe you’re pulling in prod data into staging so you can manipulate real data and run some load testing. Whatever the case, you need to import some data from one database to another.&lt;/p&gt;

&lt;p&gt;Let’s get to it. First we’re going to totally break things, because when I gave the workshop, it was live, and I broke things :) We are going to restore to the &lt;code&gt;imgblog_test&lt;/code&gt; database.&lt;/p&gt;

&lt;p&gt;But, one important thing. &lt;strong&gt;One Very Important Thing&lt;/strong&gt; When doing pg_dump, you have the two paths: human-readable and archive/compressed formats. If you choose the human-readable path, you &lt;strong&gt;&lt;em&gt;MUST&lt;/em&gt;&lt;/strong&gt; use &lt;code&gt;psql&lt;/code&gt;. If you choose the archive/compressed format, you &lt;strong&gt;&lt;em&gt;MUST&lt;/em&gt;&lt;/strong&gt; use pg_restore. Got that? In pseudocode it’s:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;use pg_dump
  if use -Fc
    use pg_restore
  else
    use psql
  end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that we got that sorted, let’s use the compressed dump to import/restore.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ pg_restore -d imgblog_test &amp;lt; ~/Desktop/dump3.dump
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you’ve been following very carefully, you will get a bunch of error output. Postgres did NOT like what just happened.  Here’s the proof:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ pg_restore: [archiver (db)] could not execute query: ERROR:  relation &quot;images&quot; does not exist
Command was: COPY images (id, img_url, img_name, description, user_id, created_at, updated_at, tags, gif, pictures) FROM stdin;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Key in the part where it says: &lt;code&gt;ERROR: relation &quot;images&quot; does not exist&lt;/code&gt;. Why’d it say that?  Remember how I said that in Rails 4.0, &lt;code&gt;rake db:setup&lt;/code&gt; creates an empty test database? Yeah…. Empty database has no tables. The import would not have worked because dump3.dump is a data-only and no-owner dump. It needs tables for data to be inserted.  Instead, let’s run dump1. Remember, since dump1 is a human-readable file, it needs to be run as psql.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ psql imgblog_test -f ~/Desktop/dump1.sql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The output should be a list of SET’s and CREATE’s and COPY’s. They will correspond to the SETs and CREATEs and COPYs in your dump1.sql file. Confirm that data has been transferred properly.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ psql imgblog_test
imgblog_test=# \dt
# confirm you have images, schema_migrations, and users
imgblog_test=# select count(*) from users;
# you should have 33 users.
imgblog_test=# select count(*) from images;
# you should have 66 images.
imgblog_test=# \q
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Fantastic job! Let’s drop the database and confirm that it is no longer there. I am using a shortcut to display the list of databases without hopping into postgres. Then we’ll set it up properly.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ RAILS_ENV=test rake db:drop
$ psql -l
# confirm that imgblog_test does not exist
$ RAILS_ENV=test rake db:setup
# this runs db:create, migrate, and seed
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, now let’s use that data-only dump file (dump3). The output of that is below the command.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ pg_restore -d imgblog_test &amp;lt; ~/Desktop/dump3.dump
# the output
pg_restore: [archiver (db)] Error while PROCESSING TOC:
pg_restore: [archiver (db)] Error from TOC entry 2284; 0    34203 TABLE DATA schema_migrations risa
pg_restore: [archiver (db)] COPY failed for table &quot;schema_    migrations&quot;: ERROR:  duplicate key value violates unique    constraint &quot;unique_schema_migrations&quot;
DETAIL:  Key (version)=(20141122220745) already exists.
CONTEXT:  COPY schema_migrations, line 1
WARNING: errors ignored on restore: 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Oh no! There’s an ERROR!! But wait, it says “duplicate key value violates unique constraint” That’s just postgres double checking your work basically. No need to worry about that. It’s basically saying that it already existed in the database, but that’s to be expected, since we ran the migrations and created the tables (and indexes).  You can confirm that data indeed was still transferred over properly.&lt;br /&gt;
…I will let you figure that one out on your own. :)&lt;/p&gt;

&lt;p&gt;OK, ONE LAST RESTORE! Imagine that you have to restore the database from your machine to another machine. Yup, you’ll need those host and port (and user, but skipping here) flags.  Before we do that, let’s reset the test database.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ RAILS_ENV=test rake db:reset
$ pg_restore -h 127.0.0.1 -p 5432 -d imgblog_test &amp;lt; ~/Documents/dump4.dump
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Again, same kind of errors, but hop in and check the data. Did it transfer over?  Awesome!&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;wrap-up&quot;&gt;Wrap up&lt;/h3&gt;

&lt;p&gt;Congratulations!! You’ve learned how to navigate about in postgres, use some SQL commands, and import and export data from postgres. You rock! Give yourself a high-5 :D&lt;/p&gt;

&lt;p&gt;Now, after reading all of this, I hope you feel a bit more comfortable reading the documentation. Here are some super helpful links.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.postgresql.org/docs/9.4/static/app-psql.html&quot;&gt;Postgres Docs: psql&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.postgresql.org/docs/9.4/static/app-pgdump.html&quot;&gt;Postgres Docs: pg_dump&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.postgresql.org/docs/9.4/static/app-pgrestore.html&quot;&gt;Postgres Docs: pg_restore&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;p&gt;Questions? Comments? Suggestions? Please let me know. You can email me at &lt;a href=&quot;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#116;&amp;#111;:&amp;#114;&amp;#105;&amp;#115;&amp;#097;&amp;#111;&amp;#110;&amp;#114;&amp;#097;&amp;#105;&amp;#108;&amp;#115;&amp;#064;&amp;#103;&amp;#109;&amp;#097;&amp;#105;&amp;#108;&amp;#046;&amp;#099;&amp;#111;&amp;#109;&quot;&gt;risaonrails &lt;i class=&quot;fa fa-paper-plane-o&quot;&gt;&lt;/i&gt;&lt;/a&gt;. No question is too dumb.&lt;/p&gt;

&lt;p&gt;&lt;i class=&quot;fa fa-angle-double-up&quot;&gt;&lt;/i&gt; Level up +10&lt;/p&gt;

</description>
        <pubDate>Wed, 18 Mar 2015 00:00:00 -0700</pubDate>
        <link>http://risaonrails.com/postgres-workshop-notes/</link>
        <guid isPermaLink="true">http://risaonrails.com/postgres-workshop-notes/</guid>
        
        
        <category>postgres</category>
        
      </item>
    
  </channel>
</rss>
